name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DENO_VERSION: v1.x
  NO_COLOR: 1
  DENO_TESTING: 1

jobs:
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ” Check formatting
        run: deno fmt --check

      - name: ğŸ”¬ Lint code
        run: deno lint

      - name: ğŸ”„ Check imports
        run: deno check src/**/*.ts

  test-quick:
    name: âš¡ Quick Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        run: deno cache --reload src/**/*.ts tests/**/*.ts scripts/**/*.ts

      - name: âš¡ Run quick tests
        run: deno run --allow-all scripts/test.ts --quick

  test-full:
    name: ğŸ”¬ Full Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        run: deno cache --reload src/**/*.ts tests/**/*.ts scripts/**/*.ts

      - name: ğŸ”¬ Run full test suite
        run: deno run --allow-all scripts/test.ts --full

      - name: ğŸ“Š Generate test coverage
        if: matrix.os == 'ubuntu-latest'
        run: |
          deno test --allow-all --coverage=coverage_profile
          deno coverage coverage_profile --lcov --output=coverage.lcov

      - name: ğŸ“ˆ Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.lcov
          fail_ci_if_error: false

  test-performance:
    name: ğŸƒ Performance Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        run: deno cache --reload src/**/*.ts tests/**/*.ts scripts/**/*.ts

      - name: ğŸƒ Run performance benchmarks
        run: deno run --allow-all scripts/test.ts --perf

      - name: ğŸ“Š Archive performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: |
            *.benchmark
            *.perf

  integration:
    name: ğŸ”„ Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test-quick]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        run: deno cache --reload src/**/*.ts tests/**/*.ts scripts/**/*.ts

      - name: ğŸ”§ Test project initialization
        run: |
          mkdir test-project
          cd test-project
          echo '{"name": "test", "dependencies": {"react": "^18.0.0"}}' > package.json
          echo '# Test rules' > .cursorrules
          deno run --allow-all ../src/cli/index.ts init --force

      - name: ğŸ¤– Test daemon startup
        run: |
          cd test-project
          timeout 10s deno run --allow-all ../src/daemon/index.ts || true
          # Daemon should start and create PID file within 10 seconds

      - name: ğŸ“‹ Test CLI commands
        run: |
          cd test-project
          deno run --allow-all ../src/cli/index.ts status
          deno run --allow-all ../src/cli/index.ts sync --dry-run
          deno run --allow-all ../src/cli/index.ts discover

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ”’ Run security audit
        run: |
          # Check for known vulnerable patterns
          if grep -r "eval(" src/ tests/ || grep -r "Function(" src/ tests/; then
            echo "âš ï¸ Found potential security issues with eval/Function"
            exit 1
          fi
          
          # Check for hardcoded credentials
          if grep -r -i "password\|secret\|token\|key" src/ tests/ --include="*.ts" | grep -v "test" | grep -v "example"; then
            echo "âš ï¸ Found potential hardcoded credentials"
            exit 1
          fi
          
          echo "âœ… Security scan passed"

  type-check:
    name: ğŸ“ TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ“ Type check all files
        run: |
          deno check src/**/*.ts
          deno check tests/**/*.ts
          deno check scripts/**/*.ts

      - name: ğŸ”¬ Check for type errors in tests
        run: deno test --dry-run --allow-all

  release-check:
    name: ğŸš€ Release Readiness
    runs-on: ubuntu-latest
    needs: [lint, test-full, test-performance, integration, security, type-check]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ğŸ”¨ Test build process
        run: |
          # Compile executables
          deno compile --allow-all --output=vibe-test src/cli/index.ts
          deno compile --allow-all --output=vibe-daemon-test src/daemon/index.ts
          
          # Test executables
          ./vibe-test --help
          timeout 5s ./vibe-daemon-test || true

      - name: ğŸ“¦ Verify package structure
        run: |
          # Check required files exist
          test -f README.md
          test -f ARCHITECTURE.md
          test -f deno.json
          test -f vibe
          test -f vibe-daemon
          test -d src/
          test -d tests/
          
          echo "âœ… Package structure verified"

      - name: ğŸ¯ Run full validation
        run: |
          echo "ğŸ§ª Running comprehensive validation..."
          deno run --allow-all scripts/test.ts --full
          echo "âœ… All systems go for release!"

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [lint, test-quick, test-full, test-performance, integration, security, type-check]
    if: always()
    steps:
      - name: ğŸ“Š Check results
        run: |
          if [ "${{ needs.test-full.result }}" = "success" ] && [ "${{ needs.test-quick.result }}" = "success" ]; then
            echo "âœ… All tests passed! ğŸ‰"
          else
            echo "âŒ Some tests failed. Check the logs above."
            exit 1
          fi